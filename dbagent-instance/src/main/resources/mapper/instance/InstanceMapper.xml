<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dbagent.instance.mapper.InstanceMapper">
    <resultMap id="BaseResultMap" type="com.dbagent.instance.domain.Instance">
        <id property="id" column="id"/>
        <result property="instanceId" column="instance_id"/>
        <result property="userId" column="user_id"/>
        <result property="instanceType" column="instance_type"/>
        <result property="name" column="name"/>
        <result property="host" column="host"/>
        <result property="port" column="port"/>
        <result property="databaseName" column="database_name"/>
        <result property="username" column="username"/>
        <result property="passwordEnc" column="password_enc"/>
        <result property="version" column="version"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="text" column="text"/>
    </resultMap>
    <insert id="addInstance">
        insert into sys_user_instance (user_id, instance_id, instance_type, name, host, port, database_name, username,
                                       password_enc,version, create_time, update_time, text)
        values (#{userId}, #{instanceId}, #{instanceType}, #{name}, #{host}, #{port}, #{databaseName}, #{username},
                #{passwordEnc},#{version},NOW(), NOW(), #{text})
    </insert>
    <update id="updateInstance">
        update sys_user_instance
        <set>
            <if test="instanceId != null">
                instance_id = #{instanceId},
            </if>
            <if test="instanceType != null">
                instance_type = #{instanceType},
            </if>
            <if test="name != null">
                name = #{name},
            </if>
            <if test="host != null">
                host = #{host},
            </if>
            <if test="port != null">
                port = #{port},
            </if>
            <if test="databaseName != null">
                database_name = #{databaseName},
            </if>
            <if test="username != null">
                username = #{username},
            </if>
            <if test="passwordEnc != null">
                password_enc = #{passwordEnc},
            </if>
            <if test="version != null">
                version = #{version},
            </if>
            <if test="text != null">
                text = #{text},
            </if>
            update_time = NOW()
        </set>
        where id = #{id}
    </update>
    <delete id="deleteInstance">
        delete
        from sys_user_instance
        where id = #{id}
          and user_id = #{userId}
    </delete>

    <select id="getInstances" resultType="com.dbagent.instance.domain.Instance" resultMap="BaseResultMap">
        select * from sys_user_instance
        <where>
            <if test="userId != null">
                and user_id = #{userId}
            </if>
            <if test="instanceId != null">
                and instance_id = #{instanceId}
            </if>
            <if test="instanceType != null">
                and instance_type = #{instanceType}
            </if>
            <if test="name != null">
                and name like concat('%',#{name},'%')
            </if>
            <if test="version != null">
                and version = #{version}
            </if>
        </where>
        limit #{offset}, #{limit}
    </select>
    <select id="getInstance" resultType="com.dbagent.instance.domain.Instance" resultMap="BaseResultMap">
        select *
        from sys_user_instance
        where instance_id = #{instanceId}
    </select>
    <select id="getInstanceIds">
        select instance_id
        from sys_user_instance
    </select>
</mapper>